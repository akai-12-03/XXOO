/*! Tomcat360.com (c) 2015 
	Author: Renzhao
*/
define("modules/verify-tel",["jQuery","log","validator"],function(t,e,n){"use strict";var i=t("jQuery"),r=t("log"),a=r.log,o=r.error,s=r.warn;if("undefined"==typeof i||"undefined"==typeof i.fn||"string"!=typeof i.fn.jquery)return void o("Can not find jQuery.");r.$(),a("Module VerifyTel is loading...");var l=t("validator")(),d={target:"#telphone",username:"#username",totalTime:60,type:"normal",url:ROOT_URL+"/sendcode.html",imgcode:"#imgCode"},f={1:null,2:"该手机已被注册",3:"系统错误",4:"用户不存在",5:"手机号码已存在",13:"该手机已被注册",98:"图片验证码错误",99:"一分钟内，验证码只能发送一次"},u=function(t,e){return a("VerifyTel is initializing..."),this.version="0.1.0",this.selector=t||".verifytel-box","string"!=typeof this.selector?this:(this.container=i(this.selector).first(),0===this.container.length?this:(this.input=this.container.find("input"),this.btn=this.container.find("button"),this.btn.prop("disabled",!1),this.setConfig(e),this._init(),a("VerifyTel is initialized."),this))};u.prototype={_init:function(){var t=this;return t.btn.removeProp("disabled"),t.btn.click(function(){t.sendCode()}),t},setConfig:function(t){var e=this;({telphone:e.container.data("target"),username:e.container.data("username"),imgCode:e.container.data("imgcode")});return this.params=i.extend(!0,{},d,t),this.params.url=t.url||"/sendvcode.html",this.params.done=t.done||function(t){var n=e.params.totalTime,i=window.setInterval(function(){var t=n+"秒后可重发";e.btn.text(t),0>n&&(window.clearInterval(i),e.btn.text("重新发送"),e.btn.prop("disabled",!1)),--n},1e3)},this.params.error=t.error||function(t,n){e._alert(t[n])},e},_getNoticeContainer:function(t){return t.find(".tip").length>0?t.find(".tip").first():t.find("+.tip").length>0?t.find("+.tip").first():t.parent().find("+.tip").length>0?t.parent().find("+.tip").first():i()},notice:function(t,e){var n=this._getNoticeContainer(e);n.length>0?n.text(t):s("vTel#130",e,"has no notice container.")},_alert:function(t){var e=this._getNoticeContainer(this.container);return e.length>0?e.first().text(t):(alert(t),s("vTel#142","Can not find notice container.","at input.verifytel-box")),this},sendCode:function(){this.ajaxReq&&this.ajaxReq.abort();var t=this,e=i(t.params.telphone);if(0===e.length)return s("Can not find telphone input."),!1;var n=i.trim(e.val()),r=i(t.params.imgcode),a=i.trim(r.val()),o=l.telphone(n,l,e),d=l.code(a,l,r);if(!o.status)return t.notice(o.msg,e),!1;if(!d.status&&0!=r.length)return t.notice(d.msg,r),!1;var u={phone:n,imgcode:a};if("forget"===t.params.type){u.forgetname=n,u.cto="xxoo";var p=l.telphone(u.forgetname);if(!p.status)return t._alert(p.msg),!1}else"loginname"===t.params.type?u.loginname=i(t.params.loginname).val().trim():"jyname"==t.params.type&&(u.jyname=i(t.params.jyname).val().trim());if(!(i(".verifyimg-box input").length>0))return alert("当前页面已经被非法纂改，请刷新后重试"),!1;var m=i.trim(i(".verifyimg-box input").val());return 4!==m.length?(i(".verifyimg-box input").trigger("blur"),!1):(u.imgcode=m,void(this.ajaxReq=i.ajax({url:t.params.url+"?t="+Math.random(),data:u,dataType:"json",success:function(e){var n=e;1===n?(t.btn.prop("disabled",!0),t.params.done(e)):t.params.error(f,e)},error:function(){alert("短信发送失败，可能是网络原因")}})))}},n.exports=u,a("Module VerifyTel is loaded.")});